<!doctype html>
<html>
	<head>
        <script>
            localStorage.setItem("SegundaPagina","/detalle_pedidos")
            ////////FUNCIONES PRINCIPALES DE LA PAGINA/////////////////////
            function CargarGrilla() {
            $('#tablaPrincipal').empty()
            $.ajax({
                 url : "/pedidos",
                 dataType: "json",
                 success : function (data) {
					console.log(data)
					
                    localStorage.setItem("DatosCargadosGrilla",JSON.stringify(data))
                          // una vez que obtenga el json parseo los resultados
                        $datos = $('#tablaPrincipal');
    
                        // creo la tabla y muestro los datos
                        $tabla = $('<table id="table" class="table table-striped" width="200" border="1"><tbody class="table table-striped" width="200" border="1"><tr><th scope="col">Id</th><th scope="col">Paciente</th><th scope="col">Vendedor</th><th scope="col">Producto</th><th scope="col">Estado</th><th scope="col">Pago</th><th scope="col">Cantidad</th><th scope="col">Sub Total</th></tr></tbody></table>');
                        
						var prueba;
                        // hago un ciclo
						console.log(data)
                        for (var i = 0; i < data.length; i++) {
							var urlPacientes=data[i].paciente
							var urlVendedores=data[i].vendedor
							var urlProducto=data[i].producto
							var urlEstado=data[i].estado
							var urlPago=data[i].pago
							
							
							$.ajax({
                 			url : urlPacientes,
                 			dataType: "json",
							async: false,
                 			success : function (paciente) {
							localStorage.setItem("paciente_nombre",paciente.nombre_apellido);
							localStorage.setItem("paciente_id",paciente.id);
							//console.log(medico.nombre)
							}
							})

							$.ajax({
                 			url : urlVendedores,
                 			dataType: "json",
							async: false,
                 			success : function (vendedor) {
							localStorage.setItem("vendedor_nombre",vendedor.apellido);
							localStorage.setItem("vendedor_id",vendedor.id);
							//console.log(prueba)
							}
							})

							$.ajax({
                 			url : urlProducto,
                 			dataType: "json",
							async: false,
                 			success : function (producto) {
							localStorage.setItem("producto_nombre",producto.nombre);
							localStorage.setItem("producto_precio",producto.precio);
							localStorage.setItem("producto_id",producto.id);
							//console.log(prueba)
							}
							})

							$.ajax({
                 			url : urlEstado,
                 			dataType: "json",
							async: false,
                 			success : function (estado) {
							localStorage.setItem("estado_nombre",estado.descripcion);
							localStorage.setItem("estado_id",estado.id);
							//console.log(prueba)
							}
							})

							$.ajax({
                 			url : urlPago,
                 			dataType: "json",
							async: false,
                 			success : function (pago) {
							localStorage.setItem("pago_nombre",pago.descripcion);
							localStorage.setItem("pago_id",pago.id);
							//console.log(prueba)
							}
							})
							var urlPacientes=data[i].paciente
							var urlVendedores=data[i].vendedor
							var urlProducto=data[i].producto
							var urlEstado=data[i].estado
							var urlPago=data[i].pago

							var pacienteNombre= localStorage.getItem("paciente_nombre");
							var pacienteId=localStorage.getItem("paciente_id");
							var vendedoresNombre= localStorage.getItem("vendedor_nombre");
							var vendedoresId=localStorage.getItem("vendedoro_id");
							var productoNombre= localStorage.getItem("producto_nombre");
							var productoId=localStorage.getItem("producto_id");
							var estadoNombre= localStorage.getItem("estado_nombre");
							var estadoId=localStorage.getItem("estado_id");
							var pagoNombre= localStorage.getItem("pago_nombre");
							var pagoId=localStorage.getItem("pago_id");
							var precio=localStorage.getItem("producto_precio");

                            var $tr = $('<tr>');
                            $tr.append('<td id="id" class="id">' + data[i].id + '</td>');
							$tr.append('<td id="paciente_nombre" class="fecha">' + pacienteNombre + '</td>');
                            $tr.append('<td id="fecha" class="fecha">' + vendedoresNombre + '</td>');
                            $tr.append('<td id="hora" class="hora">' +  productoNombre + '</td>');
							$tr.append('<td id="medico_nombre" class="medico">' + estadoNombre + '</td>');
							$tr.append('<td id="medico_nombre" class="medico">' + pagoNombre + '</td>');
							$tr.append('<td id="id" class="id">' + data[i].cantidad + '</td>');
							$tr.append('<td id="id" class="id">' + data[i].subtotal + '</td>');
                            $tr.append('<td><button class="btn btn-primary" onClick="Editar_Ver()">Ver</button></td>');
                            $tr.append('<td><button class="btn btn-primary" onClick="Editar_Ver()">Editar</button></td>');
                            $tr.append('<td><button class="btn btn-primary" onClick="eliminar()">Eliminar</button></td>');
							$tr.append('<td style="visibility:hidden" id="paciente_id" class="fecha">' + pacienteId + '</td>');
							$tr.append('<td style="visibility:hidden" id="medico_id" class="medico">' + vendedoresId + '</td>');
                            $tr.append('<td style="visibility:hidden" id="medico_id" class="medico">' + productoId + '</td>');
							$tr.append('<td style="visibility:hidden" id="medico_id" class="medico">' + estadoId + '</td>');
							$tr.append('<td style="visibility:hidden" id="medico_id" class="medico">' + pagoId + '</td>');
							$tr.append('<td style="visibility:hidden" id="medico_id" class="medico">' + precio + '</td>');
							$tr.append('</tr>')
                            // agrego la columna tr a la tabla
                            $tabla.append($tr);

                        }
    
                        // agrego la tabla al div TablaPrincipal
                        $datos.append($tabla);
					
	
						
			}
            })
			}

            function Editar_Ver(accion){
            location.href = localStorage.setItem("accion","editar");
            $('#table tr').on("click",function() {
            var id = $(this).find("td").eq(0).html();
            var paciente_nombre= $(this).find("td").eq(1).html(); 
            var vendedor_nombre = $(this).find("td").eq(2).html();
            var producto_nombre = $(this).find("td").eq(3).html();
            var estado_nombre= $(this).find("td").eq(4).html();
			var pago_nombre= $(this).find("td").eq(5).html();
			var cantidad = $(this).find("td").eq(6).html();
			var subtotal = $(this).find("td").eq(7).html();
			var paciente_id = $(this).find("td").eq(11).html();
			var vendedor_id = $(this).find("td").eq(12).html();
			var producto_id = $(this).find("td").eq(13).html();
			var estado_id = $(this).find("td").eq(14).html();
			var pago_id = $(this).find("td").eq(15).html();
			var producto_precio= $(this).find("td").eq(16).html();
            var datos= {
                id: id,
                paciente_nombre: paciente_nombre,
                vendedor_nombre: vendedor_nombre,
                producto_nombre:producto_nombre,
                estado_nombre: estado_nombre,
				pago_nombre: pago_nombre,
				cantidad: cantidad,
				subtotal: subtotal,
				vendedor_id: vendedor_id,
				producto_id: producto_id,
				estado_id: estado_id,
				pago_id: pago_id,
				producto_precio : producto_precio
            } 
			console.log(datos)  
            localStorage.setItem("valoresFilaSeccionada",JSON.stringify(datos))
            //window.open("/aaa","ventana1","width=500,height=500,scrollbars=NO")
            location.href = localStorage.getItem("SegundaPagina");
            });
            }

            function eliminar(){
            var confirmar_eliminar=ConfirmDelete();
            if (confirmar_eliminar===true){                
                $('#table tr').on("click",function() {
                var Id = $(this).find("td").eq(0).html();
                var url="/pedidos/"+Id
                $.ajax({
                 url : url,
                 type: "DELETE",
                 dataType: "json",
                 data:Id,
                 success : function (data) {
                    alert("Eliminado")
                    location.reload();
                }
                })

            })
             }else{
                 alert("no se elimina")
             }  
            }

            function ConfirmDelete()
            {
                var x = confirm("Confirma que desea eliminar el registro?");
                if (x)
                    return true;
                else
                    return false;
             }


            function AgregarDatos(){
            var accion="agregar";
            localStorage.setItem("accion",accion)
            localStorage.removeItem("valoresFilaSeccionada")
            location.href = localStorage.getItem("SegundaPagina");
            }

            

            function buscar() {
                var tableReg = document.getElementById('table');
                var searchText = document.getElementById('txtBusqueda').value.toLowerCase();
                for (var i = 1; i < tableReg.rows.length; i++) {
                    var cellsOfRow = tableReg.rows[i].getElementsByTagName('td');
                    var found = false;
                    for (var j = 0; j < cellsOfRow.length && !found; j++) {
                        var compareWith = cellsOfRow[j].innerHTML.toLowerCase();
                        if (searchText.length == 0 || (compareWith.indexOf(searchText) > -1)) {
                            found = true;
                        }
                    }
                    if (found) {
                        tableReg.rows[i].style.display = '';
                    } else {
                        tableReg.rows[i].style.display = 'none';
                    }
                }
            }


        </script>
        <meta charset="utf-8">
        <title>{{title}}</title>
        <!-- <script src="http://0.0.0.0:8082/lib/zinggrid.min.js" defer></script> -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    </head>

    <body onload="CargarGrilla()">
        <div style="background-color:#7B9CF6"><h1 aling="center" class="pacientes">{{title}}</h1></div>
		<a onClick="AgregarDatos()" class="btn btn-primary btn-lg active" role="button" aria-pressed="true">Agregar {{title}}</a>
		<div class="container-sm">

		<div class="form-inline my-2 my-lg-0">
        <input class="form-control mr-sm-2" type="search" id="txtBusqueda" placeholder="Buscar" aria-label="search" onkeyup="buscar()">
        <button class="btn btn-outline-success my-2 my-sm-0" onclick="buscar()">Buscar {{title}}</button>
        </div>
         <div id="tablaPrincipal"></div> 
       
		
    </body>
</html>