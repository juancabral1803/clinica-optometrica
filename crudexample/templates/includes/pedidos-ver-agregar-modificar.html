<!doctype html>
<html>
    <head>
        <script> 
            var datosRecibidos = JSON.parse(localStorage.getItem("valoresFilaSeccionada"));
            var accion = localStorage.getItem("accion");
            
            
            function ValidarAccion(){
                console.log(accion)
                if(accion==="editar"){
                    Actualizar();
                }else{
                    AgregarNuevo()
                }
            }

               
                function Carga_Inicial(){
               
            
                    getPacientes();
                    getVendedores();
                    getProductos()
                    getEstados()
                    getPagos()
                    cargar()
                
                }
                
                
                function getPacientes(){
                var id=localStorage
                var url="/pacientes"
                $.ajax({
                url: url, 
                dataType: "json",
                success: function(data){
                    console.log(data)
                    
                   
                $.each(data,function(key, registro) {
                    $("#Select_Pacientes").append('<option value='+registro.id+'>'+registro.nombre_apellido+'</option>');
                    if (accion==='editar'){
                        $("#Select_Pacientes").val(datosRecibidos.paciente_id)
                    }
                    //$("#Select_Pacientes").val(datosRecibidos.id_paciente)
                });        
                },
                error: function(data) {
                alert('error');
                }
            });
            }


            function getVendedores(){
            $.ajax({
            type: "GET",
            url: '/vendedors', 
            dataType: "json",
            success: function(data){
            $.each(data,function(key, registro) {
                $("#Select_Vendedores").append('<option value='+registro.id+'>'+registro.apellido+'</option>');
                //$("#Select_Medicos").val(datosRecibidos.id_medico)
                if (accion==='editar'){
                        $("#Select_Vendedores").val(datosRecibidos.vendedor_id)
                    }
                    //$("#Select_Pacientes").val(datosRecibidos.id_paciente)
            });        
            },
            error: function(data) {
            alert('error');
            }
            });
            }

            function getProductos(){
            $.ajax({
            type: "GET",
            url: '/productos', 
            dataType: "json",
            success: function(data){
                localStorage.setItem("ProductosCarga",JSON.stringify(data))
            $.each(data,function(key, registro) {
                $("#Select_Productos").append('<option value='+registro.id+'>'+registro.nombre+'</option>');
                if (accion==='editar'){
                        $("#Select_Productos").val(datosRecibidos.producto_id)
                    }
                //$("#Select_Medicos").val(datosRecibidos.id_medico)
            });        
            },
            error: function(data) {
            alert('error');
            }
            });
            }

            function getEstados(){
            $.ajax({
            type: "GET",
            url: '/estados', 
            dataType: "json",
            success: function(data){
            $.each(data,function(key, registro) {
                $("#Select_Estado").append('<option value='+registro.id+'>'+registro.descripcion+'</option>');
                //$("#Select_Medicos").val(datosRecibidos.id_medico)
                if (accion==='editar'){
                        $("#Select_Estado").val(datosRecibidos.estado_id)
                    }
            });        
            },
            error: function(data) {
            alert('error');
            }
            });
            }

            function getPagos(){
            $.ajax({
            type: "GET",
            url: '/pagos', 
            dataType: "json",
            success: function(data){
            $.each(data,function(key, registro) {
                $("#Select_Pago").append('<option value='+registro.id+'>'+registro.descripcion+'</option>');
                //$("#Select_Medicos").val(datosRecibidos.id_medico)
                if (accion==='editar'){
                        $("#Select_Pago").val(datosRecibidos.pago_id)
                    }
            });        
            },
            error: function(data) {
            alert('error');
            }
            });
            }

            function cargar(){
               var datosRecibidos = JSON.parse(localStorage.getItem("valoresFilaSeccionada"));
               var accion=localStorage.getItem("accion");
               $("#id").val(datosRecibidos.id);
               $("#subtotal").val(datosRecibidos.subtotal);
               $("#cantidad").val(datosRecibidos.cantidad);
               document.getElementById('precio').innerHTML = datosRecibidos.producto_precio; 
              //document.getElementById('accion').innerHTML = accion;     
            }
            

        
            function AgregarNuevo(){
            const csrf_token = getCookie('csrftoken');
            var idPaciente=document.getElementById("Select_Pacientes").value
            var idVendedor=document.getElementById("Select_Vendedores").value
            var idProducto=document.getElementById("Select_Productos").value
            var idEstado=document.getElementById("Select_Estado").value
            var idPago=document.getElementById("Select_Pago").value
            var Paciente="http://127.0.0.1:8000/pacientes/"+idPaciente+"/";
            var Vendedor="http://127.0.0.1:8000/vendedors/"+idVendedor+"/";
            var Producto="http://127.0.0.1:8000/productos/"+idProducto+"/";
            var Estado="http://127.0.0.1:8000/estados/"+idEstado+"/";
            var Pago="http://127.0.0.1:8000/pagos/"+idPago+"/";
            var data = {};
            data.paciente = Paciente;
            data.vendedor = Vendedor;
            data.producto = Producto;
            data.estado = Estado;
            data.pago = Pago;
            data.cantidad = document.getElementById("cantidad").value;
            data.subtotal = localStorage.getItem("UltimoSubTotal")
            console.log(data)
            //var datosRecibidos = JSON.parse(localStorage.getItem("valoresFilaSeccionada"));
            $.ajax({
            type: "POST",
            url: "/pedidos/",
            data: data,
            beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            success: function (arg) {
                alert("se agrego de forma correcta")
                location.href ="/vista_pedidos";
            }
            
            });
            }
     
    
            function Actualizar(){
            const csrf_token = getCookie('csrftoken');
            var idPaciente=document.getElementById("Select_Pacientes").value
            var idVendedor=document.getElementById("Select_Vendedores").value
            var idProducto=document.getElementById("Select_Productos").value
            var idEstado=document.getElementById("Select_Estado").value
            var idPago=document.getElementById("Select_Pago").value
            var Paciente="http://127.0.0.1:8000/pacientes/"+idPaciente+"/";
            var Vendedor="http://127.0.0.1:8000/vendedors/"+idVendedor+"/";
            var Producto="http://127.0.0.1:8000/productos/"+idProducto+"/";
            var Estado="http://127.0.0.1:8000/estados/"+idEstado+"/";
            var Pago="http://127.0.0.1:8000/pagos/"+idPago+"/";
            var data = {};
            data.paciente = Paciente;
            data.vendedor = Vendedor;
            data.producto = Producto;
            data.estado = Estado;
            data.pago = Pago;
            data.cantidad = document.getElementById("cantidad").value;
            data.subtotal = localStorage.getItem("UltimoSubTotal");
            var Id=document.getElementById("id").value;
            var url="/pedidos/"+Id+"/";
            console.log(data)
            $.ajax({
            type: "patch",
            url: url,
            data: data,
            beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            success: function (arg) {
                alert("se actualizo de forma correcta")
                location.href ="/vista_pedidos";
            }
            
            });
            }
    
            function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
            }
            return cookieValue;
            }

            function volver(){
            
                location.href = "/vista_pedidos"
            }

            function calcularSubtotal(){

                var Cantidad=document.getElementById("cantidad").value
                var ProductosFiltro = JSON.parse(localStorage.getItem("ProductosCarga"));
                console.log(ProductosFiltro)
                var selec = document.getElementById("Select_Productos").value;
                console.log(selec)
                var FiltroPrecio = (ProductosFiltro.filter(function(item){return item.id == selec}));

                var precio=FiltroPrecio[0].precio;
                var subtotal=Cantidad*precio;
                localStorage.setItem("UltimoSubTotal", precio)
                localStorage.setItem("UltimoPrecio", precio)
                $("#subtotal").val(subtotal);
                document.getElementById('precio').innerHTML=precio;
                
            }
            
        </script>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

        <meta charset="utf-8">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
		
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

<meta charset="utf-8">
	
<title>{{title}}</title>
</head>


	
	<body onload="Carga_Inicial()">
	<div style="background-color:#7B9CF6"><h1 align="center" class="pedidos">{{title}}</h1></div>
		
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="well well-sm">
                <form class="form-horizontal" method="post">
                    <fieldset>
                        <legend class="text-center header">Agregar {{title}}</legend>
                        <div class="form-group">
                            <div class="col-md-8">
                                <input id="id" name="id" type="text" placeholder="id" class="form-control" style="visibility:hidden">
                            </div>
                            </div>
                            <div class="form-group">
                                <label for="exampleFormControlSelect1">Pacientes</label>
                                <select class="form-control" id="Select_Pacientes">
                                </select>
                             </div>
                             <div class="form-group">
                                <label for="exampleFormControlSelect1">Vendedores</label>
                                <select class="form-control" id="Select_Vendedores">
                                </select>
                              </div>
                              <div class="form-group">
                                <label for="exampleFormControlSelect1">Productos</label>
                                <select class="form-control" id="Select_Productos" onchange="calcularSubtotal()">
                                </select>
                              </div>
                              <div class="form-group">
                                <label for="exampleFormControlSelect1">Estado</label>
                                <select class="form-control" id="Select_Estado">
                                </select>
                              </div>

                              <div class="form-group">
                              <label for="exampleFormControlSelect1">Pago</label>
                              <select class="form-control" id="Select_Pago">
                              </select>
                            </div>
                        <div class="form-group">
                            <span class="col-md-1 col-md-offset-2 text-center"><i class="fa fa-user bigicon"></i></span>
                            <div class="col-md-8">
                                <label for="exampleFormControlSelect1">Cantidad</label><input id="cantidad" name="cantidad" type="text" placeholder="cantidad" class="form-control" onkeyup="calcularSubtotal()">
                            </div>
                        </div>
                        <div class="form-group">
                            <span class="col-md-1 col-md-offset-2 text-center"><i class="fa fa-user bigicon"></i></span>
                            <div class="col-md-8">
                                <label for="exampleFormControlSelect1">Precio: $</label>
                                <span id="precio"></span>
                                
                            </div>
                        </div>
						<div class="form-group">
                            <span class="col-md-1 col-md-offset-2 text-center"><i class="fa fa-user bigicon"></i></span>
                            <div class="col-md-8">
                                <label for="exampleFormControlSelect1">Sub total</label>
                                <input id="subtotal" name="subtotal" type="text" placeholder="Subtotal" class="form-control">
                            </div>
                        </div>
						
                        
                        

	
						<div class="btn-group col-md-8 text-center">
  <button type="button" id="guardar" class="btn btn-primary btn-lg" onclick="ValidarAccion()">Guardar</button>
  <button type="button" id="volver" class="btn btn-primary btn-lg">Volver</button>
  
</div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>
		
</body>
</html>
